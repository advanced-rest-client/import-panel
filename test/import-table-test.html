<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../node_modules/@polymer/test-fixture/test-fixture.js"></script>
    <script src="../node_modules/mocha/mocha.js"></script>
    <script src="../node_modules/chai/chai.js"></script>
    <script src="../node_modules/wct-mocha/wct-mocha.js"></script>


    <script type="module" src="../import-panel.js"></script>
    <script type="module" src="../import-data-inspector.js"></script>
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <import-data-inspector></import-data-inspector>
      </template>
    </test-fixture>

    <script type="module">
    import {DataGenerator} from '../../arc-data-generator/arc-data-generator.js';
    import {tap} from '../../../@polymer/iron-test-helpers/mock-interactions.js';
    import '../import-panel.js';
    import '../import-data-inspector.js';
    function getImportData() {
      const saved = DataGenerator.generateSavedRequestData({
        requestsSize: 10,
        projectsSize: 1
      });
      const historyData = DataGenerator.generateHistoryRequestsData({
        requestsSize: 10
      });
      return {
        'kind': 'ARC#Import',
        'createdAt': '2017-09-28T19:43:09.491',
        'version': '9.14.64.305',
        'requests': saved.requests,
        'projects': saved.projects,
        'history': historyData,
        'variables': DataGenerator.generateVariablesData(),
        'headers-sets': DataGenerator.generateHeadersSetsData(),
        'cookies': DataGenerator.generateCookiesData(),
        'url-history': DataGenerator.generateUrlsData({
          size: 10
        }),
        'websocket-url-history': DataGenerator.generateUrlsData({
          size: 5
        }),
        'auth-data': [{_id: 'test', encoded: 'test'}]
      };
    }

    suite('import table test', function() {
      let element;
      setup(function(done) {
        element = fixture('basic');
        element.data = getImportData();
        flush(() => done());
      });

      test('Computes headersSets property', function() {
        assert.typeOf(element.headersSets, 'array');
        assert.lengthOf(element.headersSets, 25);
      });

      test('Computes urls property', function() {
        assert.typeOf(element.urls, 'array');
        assert.lengthOf(element.urls, 10);
      });

      test('Computes socketUrls property', function() {
        assert.typeOf(element.socketUrls, 'array');
        assert.lengthOf(element.socketUrls, 5);
      });

      test('Fires "cancel" event', function(done) {
        element.addEventListener('cancel', function f() {
          element.removeEventListener('cancel', f);
          done();
        });
        const button = element.shadowRoot.querySelector('[data-action="cancel-import"]');
        tap(button);
      });

      test('Fires "import" event', function(done) {
        element.addEventListener('import', function f(e) {
          element.removeEventListener('import', f);
          assert.typeOf(e.detail, 'object', 'Detail is an object');
          assert.equal(e.detail.kind, 'ARC#Import', 'Detail is an import object');
          done();
        });
        const button = element.shadowRoot.querySelector('[data-action="import-data"]');
        tap(button);
      });
    });

    suite('_getTableData()', function() {
      let element;
      setup(function(done) {
        element = fixture('basic');
        element.data = getImportData();
        flush(() => done());
      });

      test('Computes list of selected requests', function() {
        const result = element._getTableData('import-websocket-url-history-table');
        assert.typeOf(result, 'array');
        assert.lengthOf(result, 5);
      });

      test('Clears "selected" property', function() {
        const result = element._getTableData('import-websocket-url-history-table');
        for (let i = 0; i < result.length; i++) {
          assert.isUndefined(result[i].selected);
        }
      });

      test('Returns undefined for hidden table', function() {
        // dmo-if hiddes the elemen t when falsy instead of removing the element
        // from the dom.
        const table = element.shadowRoot.querySelector('import-websocket-url-history-table');
        table.style.display = 'none';
        const result = element._getTableData('import-websocket-url-history-table');
        assert.isUndefined(result);
      });

      test('Returns undefined if selection is empty', function() {
        const table = element.shadowRoot.querySelector('import-websocket-url-history-table');
        table.selectedItems = [];
        const result = element._getTableData('import-websocket-url-history-table');
        assert.isUndefined(result);
      });
    });

    suite('collectData()', function() {
      let element;
      let result;
      suiteSetup(function(done) {
        element = fixture('basic');
        element.data = getImportData();
        flush(() => done());
      });

      test('Returns an object', function() {
        result = element.collectData();
        assert.typeOf(result, 'object');
      });

      test('Returned data is the ARC import object', function() {
        result = element.collectData();
        assert.equal(result.kind, 'ARC#Import');
      });

      test('Has all data', function() {
        result = element.collectData();
        assert.lengthOf(Object.keys(result), 12);
      });

      test('Will not include removed in table data', function() {
        const table = element.shadowRoot.querySelector('import-websocket-url-history-table');
        table.style.display = 'none';
        result = element.collectData();
        assert.isUndefined(result['websocket-url-history']);
        table.style.display = 'block';
      });

      test('Will contain partial import', function() {
        const table = element.shadowRoot.querySelector('import-websocket-url-history-table');
        table.selectedItems = [table.selectedItems[0]];
        result = element.collectData();
        assert.lengthOf(result['websocket-url-history'], 1);
      });
    });
    </script>

  </body>
</html>
